EXECUTE BLOCK (IDFILIAL CHAR(2)     = :FILIAL,
               DATALIMITE TIMESTAMP = :DATA)
AS
DECLARE VARIABLE ID INTEGER;
DECLARE VARIABLE SERIE CHAR(5);
DECLARE VARIABLE NUMERONF INTEGER;
DECLARE VARIABLE ROWS_FDC INTEGER;
DECLARE VARIABLE DATAEMISSAO TIMESTAMP;
BEGIN
  FOR SELECT L.ID, L.SERIE, L.NUMERONF, L.DATAEMISSAO
      FROM LFNF L
      WHERE L.IDFILIAL     = :IDFILIAL AND
            L.DATAEMISSAO <= :DATALIMITE AND
            L.STATUS       = 'P'
      INTO :ID, :SERIE, :NUMERONF, :DATAEMISSAO
  DO BEGIN
       DELETE FROM LFITEMNF
       WHERE ID       = :ID AND
             IDFILIAL = :IDFILIAL;
      
       DELETE FROM LFNFXML I
       WHERE ID       = :ID AND
             IDFILIAL = :IDFILIAL;
      
       DELETE FROM LFNF L
       WHERE ID = :ID AND
             IDFILIAL = :IDFILIAL;

       SELECT FDC_ROWS
       FROM GRAVALOG('EC',
                     'IBEXPERT',
                     '','IB',
                     'DELETE LFNF PENDENTE. NUMERO: ' || :NUMERONF || ' SERIE: ' || :SERIE || ' IDFILIAL/ID: ' || :IDFILIAL || '/' || :ID || ' DATAEMISSAO: ' || :DATAEMISSAO || ' DATAFILTRO: ' || :DATALIMITE)
       INTO :ROWS_FDC;
  END
END